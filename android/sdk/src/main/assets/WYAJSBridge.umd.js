!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.WYAJSBridge=e()}(this,function(){"use strict";function i(t){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function o(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function s(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function t(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function e(t,e){return t(e={exports:{}},e.exports),e.exports}var c=e(function(t){t.exports=function(t){return t&&t.__esModule?t:{default:t}}});t(c);var a=function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t};var u=function(e){for(var t=arguments,n=1;n<arguments.length;n++){var r=null!=t[n]?t[n]:{},o=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(r).filter(function(t){return Object.getOwnPropertyDescriptor(r,t).enumerable}))),o.forEach(function(t){a(e,t,r[t])})}return e},f=e(function(e){function n(t){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function r(t){return"function"==typeof Symbol&&"symbol"===n(Symbol.iterator)?e.exports=r=function(t){return n(t)}:e.exports=r=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":n(t)},r(t)}e.exports=r});var l=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")};function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var v=function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t},y=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=c(u),s=c(f),a=c(l),n=c(v),r=function(){function i(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};(0,a.default)(this,i);var n=e.onError,r=e.onInvoke;if(Object.defineProperty(this,"$error",{value:n||function(t){console.error(t)},writable:!0}),Object.defineProperty(this,"$emit",{value:r||function(t){},writable:!0}),"object"!==(0,s.default)(t)||t instanceof i||t.__events__||t.__listeners__||t.on||t.off||t.emit)return this.$error("[wya-ps]: 不符合观察条件，请删除以下对象.\n\t\t\t\t\n__events__\n__listeners__\non\noff\nemit\n\t\t\t"),!1;for(var o in Object.defineProperty(this,"__events__",{value:{}}),Object.defineProperty(this,"__listeners__",{value:[]}),t)this[o]=t[o]}return(0,n.default)(i,[{key:"on",value:function(t,e){if("object"===(0,s.default)(t))for(key in t)t.hasOwnProperty(key)&&"function"==typeof t[key]&&this.on(key,t[key]);else"string"==typeof t&&"function"==typeof e?(this.__events__[t]||(this.__events__[t]=[]),this.__events__[t].push(e),this.$emit.call(this,"on",t,e)):"function"==typeof t&&this.__listeners__.push(t);return this}},{key:"off",value:function(t,e){return"string"!=typeof t||e?"string"==typeof t&&this.__events__[t]&&e?(this.__events__[t]=this.__events__[t].filter(function(t){return t!==e}),0===this.__events__[t].length&&delete this.__events__[t]):void 0===(0,s.default)(t)&&(this.__listeners__=[]):delete this.__events__[t],this.$emit.call(this,"off",t,e),this}},{key:"once",value:function(n,r){var o=this;if("string"==typeof n&&"function"==typeof r){this.on(n,function t(e){o.off(n,t),r.call(o,e)})}return this}},{key:"emit",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(e instanceof Array||"object"!==(0,s.default)(e)||e.event)return this.$error("[wya-ps]: ".concat(t,"事件 - 回调参数必须是对象, 且不能让带event关键字")),this;if("string"==typeof t&&this.__events__.hasOwnProperty(t)&&this.__events__[t]instanceof Array)for(var n=0;this.__events__[t]&&n<this.__events__[t].length&&!1!==this.__events__[t][n].call(this,e);n++);for(var r=0;r<this.__listeners__.length&&!1!==this.__listeners__[r].call(this,(0,o.default)({},e,{event:t}));r++);return this}}]),i}();e.default=r});t(y);var n=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),Object.defineProperty(e,"EventStore",{enumerable:!0,get:function(){return n.default}});var n=c(y)});t(n);var h=n.EventStore,_=function(t,e){p("_error_",t),e&&e({status:0,msg:t})},p=function(t,e){var n;"function"==typeof document.CustomEvent?n=new document.CustomEvent(t,{bubbles:!0,cancelable:!0}):"function"==typeof document.createEvent&&(n=document.createEvent("Event")).initEvent(t,!0,!0),e&&n&&(n.data=e),n?window.dispatchEvent(n):console.error("Bridge Error: dispatchEvent")};return new(function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.version="1.0.0",this.store={},this.count=0,this.source=new h({},{onError:_}),this.initCount=0,this.waitEmit=[],this.nativeEvents=[],this.saveParam=this.saveParams,this.parseParam=this.parseParams,this.getParam=this.getParams}var e,n,r;return e=t,(n=[{key:"saveParams",value:function(t,e){var n=this.count++,r="".concat(t,"__").concat(n);return this.store[n]={params:e,scheme:t,eventName:r},{id:n,eventName:r}}},{key:"getParams",value:function(t){return(this.store[t]||{}).params}},{key:"parseParams",value:function(t){var e="object"===i(t[0]),n="object"===i(t[1]),r={};return e&&(delete(r=function(o){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},e=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(e=e.concat(Object.getOwnPropertySymbols(i).filter(function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable}))),e.forEach(function(t){var e,n,r;e=o,r=i[n=t],n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r})}return o}({},reset[0])).success,delete r.fail),{params:r,success:(e?t[0].success:t[0])||function(){},fail:(n?t[0].fail:t[1])||function(){}}}},{key:"setNativeEvents",value:function(t,e){this.nativeEvents=t?[].concat(s(this.nativeEvents),[e]):this.nativeEvents.filter(function(t){return t!=e})}},{key:"sendEvent",value:function(e,n){var t=arguments,r=this;if(!/(_error_|_ready_|_log_)/.test(n)){for(var o=arguments.length,i=new Array(2<o?o-2:0),s=2;s<o;s++)i[s-2]=t[s];var a=this.parseParams(i),c=(a.success,a.fail);if(!e||!this.nativeEvents.includes(n)){var u=this.source.__events__[n];if(!(!e&&u&&0<u.length)){var f=e?"event/add":"event/remove",l=e?"开启":"关闭";this.setNativeEvents(e,n),this.invoke(f,{eventName:n}).then(function(t){p("_log_","".concat(n).concat(l,"成功"))}).catch(function(t){r.setNativeEvents(!e,n),c(t),_("".concat(n).concat(l,"失败"))})}}}}},{key:"invoke",value:function(n,s){var a=this;return new Promise(function(r,o){if(n){s=s?decodeURIComponent(JSON.stringify(s)):"";var t=a.saveParams(n,s),i=t.id,e=t.eventName;a.source.once(e,function(t){var e=t.data,n=t.status;t.msg;1==n?r(e):o(t),delete a.store[i]}),a._send(i)}else _("scheme 方法名必传",o)})}},{key:"on",value:function(t){for(var e=arguments,n=arguments.length,r=new Array(1<n?n-1:0),o=1;o<n;o++)r[o-1]=e[o];var i=this.parseParams(r),s=i.success,a=i.fail;this.source.on(t,function(t){var e=t.data,n=t.status;t.msg;1==n?s(e):a(t)}),this.sendEvent.apply(this,[!0,t].concat(r))}},{key:"off",value:function(t){for(var e,n=arguments,r=arguments.length,o=new Array(1<r?r-1:0),i=1;i<r;i++)o[i-1]=n[i];(e=this.source).off.apply(e,[t].concat(o)),this.sendEvent.apply(this,[!1,t].concat(o))}},{key:"emit",value:function(t,e){var n=(this.store[t]||{}).eventName,r=void 0===n?t:n;if("_error_"!==r&&"string"==typeof e)try{e=JSON.parse(e)||{}}catch(t){_("Native端返回格式错误: ".concat(e))}if("object"!==i(e)||void 0!==e.status)switch(r){case"_ready_":if(this.initCount++,1===this.initCount)p(r,e),this.waitEmit.forEach(function(t,e){return t()}),this.waitEmit=[];else{var o="_ready_ 事件, 只允许初始化一次";p(r,{status:0,msg:o}),_(o)}break;case"_error_":_(e);default:this.source.emit(r,e)}else _("Native端返回格式错误: ".concat(e))}},{key:"once",value:function(n){for(var t=arguments,r=this,e=arguments.length,o=new Array(1<e?e-1:0),i=1;i<e;i++)o[i-1]=t[i];var s=this.parseParams(o),a=s.success,c=s.fail;if("string"==typeof n&&"function"==typeof a){var u=function t(e){r.off(n,t),a(e)};this.on(n,u,function(t){r.off(n,u),c(t)})}}},{key:"last",value:function(t){var e=arguments;this.off(t);for(var n=arguments.length,r=new Array(1<n?n-1:0),o=1;o<n;o++)r[o-1]=e[o];this.on.apply(this,[t].concat(r))}},{key:"first",value:function(t){var e=arguments;if(this.source.__events__[t]||0===this.source.__events__[t].length){for(var n=arguments.length,r=new Array(1<n?n-1:0),o=1;o<n;o++)r[o-1]=e[o];this.on.apply(this,[t].concat(r))}else{var i="".concat(t,"只执行触发一次绑定");_(i)}}},{key:"_send",value:function(e){if(0!==this.initCount){var t=this.store[e]||{},n=t.scheme;t.eventName;setTimeout(function(){var t=document.createElement("iframe");t.src="command://".concat(n,"?id=").concat(e),t.style.display="none",document.body.appendChild(t),setTimeout(function(){t.parentNode.removeChild(t)},300)},0)}else this.waitEmit.push(this._send.bind(this,e))}}])&&o(e.prototype,n),r&&o(e,r),t}())});
