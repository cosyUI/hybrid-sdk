!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.WYAJSBridge=t()}(this,function(){"use strict";function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function t(e,t){return e(t={exports:{}},t.exports),t.exports}var a=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var o=Object.assign||function(e){for(var t=arguments,n=1;n<arguments.length;n++){var r=t[n];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();var r=function(){function i(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i);var n=t.onError,r=t.onInvoke;if(Object.defineProperty(this,"$error",{value:n||function(e){console.error(e)},writable:!0}),Object.defineProperty(this,"$emit",{value:r||function(e){},writable:!0}),"object"!==(void 0===e?"undefined":s(e))||e instanceof i||e.__events__||e.__listeners__||e.on||e.off||e.emit)return this.$error("[wya-ps]: 不符合观察条件，请删除以下对象.\n\t\t\t\t\n__events__\n__listeners__\non\noff\nemit\n\t\t\t"),!1;for(var o in Object.defineProperty(this,"__events__",{value:{}}),Object.defineProperty(this,"__listeners__",{value:[]}),e)this[o]=e[o]}return n(i,[{key:"on",value:function(e,t){if("object"===(void 0===e?"undefined":s(e)))for(key in e)e.hasOwnProperty(key)&&"function"==typeof e[key]&&this.on(key,e[key]);else"string"==typeof e&&"function"==typeof t?(this.__events__[e]||(this.__events__[e]=[]),this.__events__[e].push(t),this.$emit.call(this,"on",e,t)):"function"==typeof e&&this.__listeners__.push(e);return this}},{key:"off",value:function(e,t){return"string"!=typeof e||t?"string"==typeof e&&this.__events__[e]&&t?(this.__events__[e]=this.__events__[e].filter(function(e){return e!==t}),0===this.__events__[e].length&&delete this.__events__[e]):void 0===(void 0===e?"undefined":s(e))&&(this.__listeners__=[]):delete this.__events__[e],this.$emit.call(this,"off",e,t),this}},{key:"once",value:function(n,r){var o=this;if("string"==typeof n&&"function"==typeof r){this.on(n,function e(t){o.off(n,e),r.call(o,t)})}return this}},{key:"emit",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(t instanceof Array||"object"!==(void 0===t?"undefined":s(t))||t.event)return this.$error("[wya-ps]: "+e+"事件 - 回调参数必须是对象, 且不能让带event关键字"),this;if("string"==typeof e&&this.__events__.hasOwnProperty(e)&&this.__events__[e]instanceof Array)for(var n=0;this.__events__[e]&&n<this.__events__[e].length&&!1!==this.__events__[e][n].call(this,t);n++);for(var r=0;r<this.__listeners__.length&&!1!==this.__listeners__[r].call(this,o({},t,{event:e}));r++);return this}}]),i}();t.default=r});e(a);var n=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.EventStore=void 0;var n,r=(n=a)&&n.__esModule?n:{default:n};t.EventStore=r.default});e(n);var c=n.EventStore,l=function(e,t){f("_error_",e),t&&t({status:0,msg:e})},f=function(e,t){var n;"function"==typeof document.CustomEvent?n=new document.CustomEvent(e,{bubbles:!0,cancelable:!0}):"function"==typeof document.createEvent&&(n=document.createEvent("Event")).initEvent(e,!0,!0),t&&n&&(n.data=t),n?window.dispatchEvent(n):console.error("Bridge Error: dispatchEvent")};return new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.version="1.0.0",this.store={},this.count=0,this.source=new c({},{onError:l}),this.initCount=0,this.waitEmit=[],this.nativeEvents=[],this.saveParam=this.saveParams,this.parseParam=this.parseParams,this.getParam=this.getParams}var t,n,r;return t=e,(n=[{key:"saveParams",value:function(e,t){var n=this.count++,r="".concat(e,"__").concat(n);return this.store[n]={params:t,scheme:e,eventName:r},{id:n,eventName:r}}},{key:"getParams",value:function(e){return(this.store[e]||{}).params}},{key:"parseParams",value:function(e){var t="object"===i(e[0]),n="object"===i(e[1]),r={};return t&&(delete(r=function(o){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},t=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(t=t.concat(Object.getOwnPropertySymbols(i).filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable}))),t.forEach(function(e){var t,n,r;t=o,r=i[n=e],n in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r})}return o}({},reset[0])).success,delete r.fail),{params:r,success:(t?e[0].success:e[0])||function(){},fail:(n?e[0].fail:e[1])||function(){}}}},{key:"setNativeEvents",value:function(e,t){this.nativeEvents=e?[].concat(s(this.nativeEvents),[t]):this.nativeEvents.filter(function(e){return e!=t})}},{key:"sendEvent",value:function(t,n){var e=arguments,r=this;if(!/(_error_|_ready_)/.test(n)){for(var o=arguments.length,i=new Array(2<o?o-2:0),s=2;s<o;s++)i[s-2]=e[s];var a=this.parseParams(i),c=(a.success,a.fail);if(!t||!this.nativeEvents.includes(n)){var f=this.source.__events__[n];if(!(!t&&f&&0<f.length)){var u=t?"event/add":"event/remove",v=t?"开启":"关闭";this.setNativeEvents(t,n),this.invoke(u,{eventName:n}).then(function(){}).catch(function(e){r.setNativeEvents(!t,n),c(e),l("".concat(n).concat(v,"失败"))})}}}}},{key:"invoke",value:function(n,s){var a=this;return new Promise(function(r,o){if(n){s=s?decodeURIComponent(JSON.stringify(s)):"";var e=a.saveParams(n,s),i=e.id,t=e.eventName;a.source.once(t,function(e){var t=e.data,n=e.status;e.msg;1==n?r(t):o(e),delete a.store[i]}),a._send(i)}else l("scheme 方法名必传",o)})}},{key:"on",value:function(e){for(var t=arguments,n=arguments.length,r=new Array(1<n?n-1:0),o=1;o<n;o++)r[o-1]=t[o];var i=this.parseParams(r),s=i.success,a=i.fail;this.source.on(e,function(e){var t=e.data,n=e.status;e.msg;1==n?s(t):a(e)}),this.sendEvent.apply(this,[!0,e].concat(r))}},{key:"off",value:function(e){for(var t,n=arguments,r=arguments.length,o=new Array(1<r?r-1:0),i=1;i<r;i++)o[i-1]=n[i];(t=this.source).off.apply(t,[e].concat(o)),this.sendEvent.apply(this,[!1,e].concat(o))}},{key:"emit",value:function(e,t){var n=(this.store[e]||{}).eventName,r=void 0===n?e:n;if("_error_"!==r&&"string"==typeof t)try{t=JSON.parse(t)||{}}catch(e){l("Native端返回格式错误: ".concat(t))}if("object"!==i(t)||void 0!==t.status)switch(r){case"_ready_":if(this.initCount++,1===this.initCount)f(r,t),this.waitEmit.forEach(function(e,t){return e()}),this.waitEmit=[];else{var o="_ready_ 事件, 只允许初始化一次";f(r,{status:0,msg:o}),l(o)}break;case"_error_":l(t);default:this.source.emit(r,t)}else l("Native端返回格式错误: ".concat(t))}},{key:"once",value:function(n){for(var e=arguments,r=this,t=arguments.length,o=new Array(1<t?t-1:0),i=1;i<t;i++)o[i-1]=e[i];var s=this.parseParams(o),a=s.success,c=s.fail;if("string"==typeof n&&"function"==typeof a){var f=function e(t){r.off(n,e),a(t)};this.on(n,f,function(e){r.off(n,f),c(e)})}}},{key:"last",value:function(e){var t=arguments;this.off(e);for(var n=arguments.length,r=new Array(1<n?n-1:0),o=1;o<n;o++)r[o-1]=t[o];this.on.apply(this,[e].concat(r))}},{key:"first",value:function(e){var t=arguments;if(this.source.__events__[e]||0===this.source.__events__[e].length){for(var n=arguments.length,r=new Array(1<n?n-1:0),o=1;o<n;o++)r[o-1]=t[o];this.on.apply(this,[e].concat(r))}else{var i="".concat(e,"只执行触发一次绑定");l(i)}}},{key:"_send",value:function(t){if(0!==this.initCount){var e=this.store[t]||{},n=e.scheme;e.eventName;setTimeout(function(){var e=document.createElement("iframe");e.src="command://".concat(n,"?id=").concat(t),e.style.display="none",document.body.appendChild(e),setTimeout(function(){e.parentNode.removeChild(e)},300)},0)}else this.waitEmit.push(this._send.bind(this,t))}}])&&o(t.prototype,n),r&&o(t,r),e}())});
